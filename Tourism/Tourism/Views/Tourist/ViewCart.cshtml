@using Tourism.ViewModel
@model List<ProductViewModel>

@{
    Layout = "EcommerceLayout";
}


<!-- Cart Section -->
<section class="cart-section">
    <div class="row">
        <div class="col-lg-9">
            <div class="cart-header">
                <h1 class="cart-title">Shopping Cart</h1>
                <a href="#" class="deselect-link" onclick="deselectAll(event)">Deselect all items</a>
            </div>

            <div class="price-header">Price</div>

            @if (Model == null || !Model.Any())
            {
                <div class="empty-cart">
                    <p class="empty-cart-message">Your cart is empty</p>
                    <a href="#" class="btn-continue-shopping">Continue Shopping</a>
                </div>
            }
            else
            {
                @for (int i = 0; i < Model.Count; i++)
                {
                    var product = Model[i];
                    <div class="cart-item" data-product-id="@product.productId" data-index="@i">
                        <div class="item-checkbox">
                            <input type="checkbox"
                                   class="item-select-checkbox"
                                   data-price="@(product.price - (product.price * product.offer / 100.0))"
                                   data-quantity="1"
                                   data-product-id="@product.productId"
                                   data-deliverswithin="@product.DeliversWithin"
                                   data-id="@product.id"
                                   data-name="@product.name"
                                   data-index="@i"
                            @(product.count > 0 ? "checked" : "disabled")
                                   onchange="updateTotal()" />
                        </div>

                        <div>
                            @if (product.UploadedImages != null && product.UploadedImages.Any())
                            {
                                using (var ms = new MemoryStream())
                                {
                                    product.UploadedImages[0].CopyTo(ms);
                                    var bytes = ms.ToArray();
                                    <img class="item-image" src="data:image/jpeg;base64,@Convert.ToBase64String(bytes)" alt="@product.name" />
                                }
                            }
                            else
                            {
                                <img class="item-image" src="@Url.Content("~/pics/placeholder.jpg")" alt="@product.name" />
                            }
                        </div>

                        <div class="item-details">
                            <h3 class="item-name">
                                <a asp-action="ViewProduct" asp-controller="Tourist" asp-route-id="@product.productId"
                                   style="color: inherit; text-decoration: none;">
                                    @product.name
                                </a>
                            </h3>
                            @if (product.count > 0)
                            {
                                <div class="in-stock">In Stock (@product.count available)</div>
                            }
                            else
                            {
                                <div style="color: #dc3545; font-size: 0.85rem; font-weight: 600;">Out of Stock</div>
                            }

                            <div class="item-actions">
                                <div class="quantity-selector">
                                    <button type="button" onclick="decrementQuantity(this)" @(product.count == 0 ? "disabled" : "")>−</button>
                                    <input type="number"
                                           value="1"
                                           min="1"
                                           max="@product.count"
                                           readonly
                                           class="quantity-input"
                                           data-index="@i" />
                                    <button type="button" onclick="incrementQuantity(this)" @(product.count == 0 ? "disabled" : "")>+</button>
                                </div>
                                <form asp-action="RemoveFromCart" asp-controller="Tourist" method="post" style="display:inline;">
                                    <button type="button"
                                            class="action-link delete-btn"
                                            style="background:none;border:none;padding:0;display:flex;align-items:center;gap:4px;cursor:pointer;"
                                            data-product-id="@product.productId">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"></path>
                                            <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1z"></path>
                                        </svg>
                                        Delete
                                    </button>
                                </form>

                            </div>
                        </div>

                        <div class="item-price">
                            @if (product.offer > 0)
                            {
                                var discountedPrice = product.price - (product.price * product.offer / 100.0);
                                <div>
                                    <span class="current-price">$@discountedPrice.ToString("0.00")</span>
                                    <span class="original-price">$@product.price.ToString("0.00")</span>
                                </div>
                                <div class="savings-badge">Save @product.offer% on 1 item</div>
                            }
                            else
                            {
                                <span class="current-price">$@product.price.ToString("0.00")</span>
                            }
                        </div>
                    </div>
                }

                <div style="text-align: right; padding: 20px 20px 20px 0; border-bottom: 1px solid #ddd;">
                    <span style="font-size: 1.1rem;">Subtotal (<span id="selected-count">@Model.Where(p => p.count > 0).Count()</span> items): </span>
                    <span class="subtotal-amount" id="bottom-subtotal">$@Model.Where(p => p.count > 0).Sum(p => (p.price - (p.price * p.offer / 100.0))).ToString("0.00")</span>
                </div>
            }
        </div>

        @if (Model != null && Model.Any())
        {
            <div class="col-lg-3">
                <div class="cart-summary">
                    <div class="subtotal-row">
                        <div>Subtotal (<span id="sidebar-count">@Model.Where(p => p.count > 0).Count()</span> items):</div>
                        <div class="subtotal-amount" id="sidebar-subtotal">$@Model.Where(p => p.count > 0).Sum(p => (p.price - (p.price * p.offer / 100.0))).ToString("0.00")</div>
                    </div>
                    <form asp-controller="Tourist" asp-action="ProceedToCheckout" method="post" id="checkout-form">
                        <div id="hidden-inputs-container"></div>
                        <button type="submit" class="btn-checkout" id="checkout-btn">Proceed to checkout</button>
                    </form>
                </div>
            </div>
        }
    </div>
</section>

@section Scripts {

<script>
    function incrementQuantity(btn) {
        const input = btn.previousElementSibling;
        const max = parseInt(input.getAttribute('max'));
        const currentValue = parseInt(input.value);

        if (currentValue < max) {
            input.value = currentValue + 1;
            updateQuantityInCheckbox(input);
            updateTotal();
        }
    }

    function decrementQuantity(btn) {
        const input = btn.nextElementSibling;
        const currentValue = parseInt(input.value);

        if (currentValue > 1) {
            input.value = currentValue - 1;
            updateQuantityInCheckbox(input);
            updateTotal();
        }
    }

    function updateQuantityInCheckbox(input) {
        const cartItem = input.closest('.cart-item');
        const checkbox = cartItem.querySelector('.item-select-checkbox');
        checkbox.setAttribute('data-quantity', input.value);
    }

    function updateTotal() {
        let total = 0;
        let count = 0;
        let listIndex = 0;

        // Clear hidden inputs
        const container = document.getElementById('hidden-inputs-container');
        container.innerHTML = '';

        document.querySelectorAll('.item-select-checkbox').forEach(checkbox => {
            if (checkbox.checked && !checkbox.disabled) {
                const price = parseFloat(checkbox.getAttribute('data-price'));
                const quantity = parseInt(checkbox.getAttribute('data-quantity'));
                const productId = checkbox.getAttribute('data-product-id');
                const name = checkbox.getAttribute('data-name');
                const id = checkbox.getAttribute('data-id');

                total += price * quantity;
                count++;

                // Correct hidden input creation for model binding
                const productIdInput = document.createElement('input');
                productIdInput.type = 'hidden';
                productIdInput.name = `purchaseData[${listIndex}].productId`;
                productIdInput.value = productId;
                container.appendChild(productIdInput);

               const productNameInput = document.createElement('input');
               productNameInput.type = 'hidden';
               productNameInput.name = `purchaseData[${listIndex}].name`;
               productNameInput.value = name;
               container.appendChild(productNameInput);

                const countInput = document.createElement('input');
                countInput.type = 'hidden';
                countInput.name = `purchaseData[${listIndex}].count`;
                countInput.value = quantity;
                container.appendChild(countInput);

                const deliversWithin = checkbox.getAttribute('data-deliverswithin');
                const deliversWithinInput = document.createElement('input');
                deliversWithinInput.type = 'hidden';
                deliversWithinInput.name = `purchaseData[${listIndex}].DeliversWithin`;
                deliversWithinInput.value = deliversWithin;
                container.appendChild(deliversWithinInput);

                const priceInput = document.createElement('input');
                priceInput.type = 'hidden';
                priceInput.name = `purchaseData[${listIndex}].price`;
                priceInput.value = price.toFixed(2);
                container.appendChild(priceInput);

                      const idInput = document.createElement('input');
                        idInput.type = 'hidden';
                        idInput.name = `purchaseData[${listIndex}].id`;
                        idInput.value = id;
                        container.appendChild(idInput);

                listIndex++;
            }
        });

        // Update displayed totals
        document.getElementById('bottom-subtotal').textContent = '$' + total.toFixed(2);
        document.getElementById('sidebar-subtotal').textContent = '$' + total.toFixed(2);
        document.getElementById('selected-count').textContent = count;
        document.getElementById('sidebar-count').textContent = count;

        // Show/hide checkout button
        const checkoutBtn = document.getElementById('checkout-btn');
        checkoutBtn.style.display = count > 0 ? 'block' : 'none';
    }

    function deselectAll(event) {
        event.preventDefault();
        document.querySelectorAll('.item-select-checkbox').forEach(checkbox => {
            if (!checkbox.disabled) checkbox.checked = false;
        });
        updateTotal();
    }

    document.addEventListener('DOMContentLoaded', updateTotal);

            // AJAX delete functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners to all delete buttons
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const productId = this.getAttribute('data-product-id');
                    const cartItem = this.closest('.cart-item');

                    removeFromCart(productId, cartItem);
                });
            });
        });

        function removeFromCart(productId, cartItemElement) {
            // Show loading state
            const deleteBtn = cartItemElement.querySelector('.delete-btn');
            const originalText = deleteBtn.innerHTML;
            deleteBtn.innerHTML = 'Removing...';
            deleteBtn.disabled = true;

            // Make AJAX request
            fetch('/Tourist/RemoveFromCart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `productId=${productId}`
            })
            .then(response => {
                if (response.ok) {
                    // Success - remove item from DOM
                    cartItemElement.remove();

                    // Update the total
                    updateTotal();

                    // Check if cart is now empty
                    checkIfCartEmpty();
                } else {
                    // Handle error
                    alert('Failed to remove item from cart');
                    deleteBtn.innerHTML = originalText;
                    deleteBtn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while removing the item');
                deleteBtn.innerHTML = originalText;
                deleteBtn.disabled = false;
            });
        }

        function checkIfCartEmpty() {
            const cartItems = document.querySelectorAll('.cart-item');
            const emptyCartDiv = document.querySelector('.empty-cart');
            const cartSummary = document.querySelector('.cart-summary');

            if (cartItems.length === 0) {
                // Show empty cart message
                if (!emptyCartDiv) {
                    const cartContent = document.querySelector('.col-lg-9');
                    const emptyCartHtml = `
                        <div class="empty-cart">
                            <p class="empty-cart-message">Your cart is empty</p>
                            <a href="#" class="btn-continue-shopping">Continue Shopping</a>
                        </div>
                    `;
                    // Insert after the cart header
                    const cartHeader = document.querySelector('.cart-header');
                    cartHeader.insertAdjacentHTML('afterend', emptyCartHtml);
                }

                // Hide cart summary
                if (cartSummary) {
                    cartSummary.style.display = 'none';
                }

                // Hide price header and subtotal
                const priceHeader = document.querySelector('.price-header');
                const bottomSubtotal = document.querySelector('.cart-item:last-child')?.nextElementSibling;

                if (priceHeader) priceHeader.style.display = 'none';
                if (bottomSubtotal) bottomSubtotal.style.display = 'none';
            }
        }
</script>
}
